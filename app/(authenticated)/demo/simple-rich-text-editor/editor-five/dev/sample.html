<div
    data-editor-id="main-editor"
    class="min-h-48 p-4 focus:outline-none text-neutral-950 dark:text-neutral-50 whitespace-pre-wrap border-t border-gray-300 dark:border-gray-700"
    contenteditable="true"
    role="textbox"
    aria-multiline="true"
    spellcheck="true"
>
    <span
        >&ZeroWidthSpace;<span
            >&nbsp;<span class="chip-wrapper"
                ><span
                    contenteditable="false"
                    class="inline-flex items-center px-2 py-1 mx-1 rounded-md cursor-move bg-blue-300 dark:bg-blue-800 text-blue-900 dark:text-blue-100 hover:bg-blue-400 dark:hover:bg-blue-700 transition-colors duration-200"
                    data-chip="true"
                    data-chip-id="7e507d19-2ddd-404c-a1f8-eae2ec897579"
                    data-chip-label="New Chip 1"
                    data-chip-original-content=""
                    data-broker-id="disconnected"
                    draggable="true"
                    >New Chip 1</span
                ></span
            >&nbsp;&ZeroWidthSpace;<span
                >&nbsp;<span class="chip-wrapper"
                    ><span class="chip-wrapper"
                        ><span
                            contenteditable="false"
                            class="inline-flex items-center px-2 py-1 mx-1 rounded-md cursor-move bg-teal-300 dark:bg-teal-800 text-teal-900 dark:text-teal-100 hover:bg-teal-400 dark:hover:bg-teal-700 transition-colors duration-200"
                            data-chip="true"
                            data-chip-id="bda6504d-29a5-461f-8d4e-ee36223521be"
                            data-chip-label="useState useCallback RefObject"
                            data-chip-original-content="import { useState, useCallback, RefObject } from 'react';
    import { EditorRef, EditorHookResult, TextStyle, ChipData, ChipRequestOptions } from './types';
    import {
        ensureValidContainer,
        createChipElement,
        getDropRange,
        isValidDropTarget,
        extractTextContent,
        applyTextStyle,
        getSelectedText,
        isValidChipText,
    } from './utils/editorUtils';
    import { generateChipLabel } from './utils/generateBrokerName';
    import { v4 as uuidv4 } from 'uuid'
    import { getNextAvailableColor } from './utils/colorUitls';
    import { string } from 'zod';
    
    
    
    export const useEditor = (editorRef: RefObject<HTMLDivElement>): EditorHookResult => {
        const [chipCounter, setChipCounter] = useState(1);
        const [draggedChip, setDraggedChip] = useState<HTMLElement | null>(null);
        const [plainTextContent, setPlainTextContent] = useState('');
        const [chipData, setChipData] = useState<ChipData[]>([]);
        const [colorAssignments, setColorAssignments] = useState<Map<string, string>>(new Map());
    
        const createNewChipData = useCallback(
            (requestOptions: ChipRequestOptions = {}): ChipData => {
                console.log('Creating new chip data with current state ChipData: ', chipData);
                const id = requestOptions.id ?? uuidv4();
                const stringValue = requestOptions.stringValue ?? '';
                const label = requestOptions.label ?? generateChipLabel({ chipData, requestOptions });
                const color = requestOptions.color ?? getNextAvailableColor(colorAssignments);
                const brokerId = requestOptions.brokerId ?? 'disconnected';
                
                setColorAssignments((prev) => new Map(prev).set(id, color));
    
                return {
                    id,
                    label,
                    stringValue,
                    color,
                    brokerId,
                };
            },
            [chipData, colorAssignments]
        );
    
        const addChipData = useCallback((data: ChipData) => {
            setChipData((prev) => [...prev, data]);
            setChipCounter((prev) => prev + 1);
        }, []);
    
        const removeChipData = useCallback((chipId: string) => {
            setChipData((prev) => prev.filter((chip) => chip.id !== chipId));
        }, []);
    
        const getText = useCallback(() => {
            return plainTextContent;
        }, [plainTextContent]);
    
        const updatePlainTextContent = useCallback(() => {
            if (!editorRef.current) return;
            const text = extractTextContent(editorRef.current);
            setPlainTextContent(text);
        }, [editorRef]);
    
        const normalizeContent = useCallback(() => {
            if (!editorRef.current) return;
            console.log('Normalizing content');
            const walker = document.createTreeWalker(editorRef.current, NodeFilter.SHOW_TEXT, null);
    
            let node;
            while ((node = walker.nextNode())) {
                if (node.parentNode === editorRef.current) {
                    const span = document.createElement('span');
                    node.parentNode.insertBefore(span, node);
                    span.appendChild(node);
                }
            }
        }, [editorRef]);
    
        const insertChip = useCallback(() => {
            const chipData = createNewChipData();
            const editor = editorRef.current;
            const selection = window.getSelection();
    
            if (!editor || !selection) return;
    
            const currentRange = ensureValidContainer(editor, selection);
    
            const chipWrapper = document.createElement('span');
            chipWrapper.className = 'chip-wrapper';
    
            const chip = createChipElement(chipData);
            chip.addEventListener('dragstart', handleNativeDragStart);
            chip.addEventListener('dragend', handleNativeDragEnd);
    
            const leadingSpace = document.createTextNode('\u00A0');
            const trailingSpace = document.createTextNode('\u00A0');
            const anchorNode = document.createTextNode('\u200B');
    
            let container = currentRange.commonAncestorContainer;
            if (container.nodeType === Node.TEXT_NODE) {
                container = container.parentNode;
            }
    
            if (container === editor) {
                const span = document.createElement('span');
                span.appendChild(document.createTextNode('\u200B'));
    
                if (currentRange.startContainer === editor) {
                    editor.insertBefore(span, editor.firstChild);
                } else {
                    editor.appendChild(span);
                }
    
                container = span;
                currentRange.selectNode(span);
            }
    
            const parent = currentRange.endContainer.parentNode;
            const insertionWrapper = document.createElement('span');
            insertionWrapper.appendChild(leadingSpace);
            insertionWrapper.appendChild(chipWrapper);
            chipWrapper.appendChild(chip);
            insertionWrapper.appendChild(trailingSpace);
            insertionWrapper.appendChild(anchorNode);
    
            if (currentRange.collapsed) {
                const insertPosition = currentRange.startContainer;
                if (insertPosition.nodeType === Node.TEXT_NODE) {
                    const textNode = insertPosition as Text;
                    const afterText = textNode.splitText(currentRange.startOffset);
                    parent?.insertBefore(insertionWrapper, afterText.parentNode?.nextSibling || null);
                } else {
                    parent?.insertBefore(insertionWrapper, container.nextSibling);
                }
            } else {
                currentRange.deleteContents();
                currentRange.insertNode(insertionWrapper);
            }
    
            const finalRange = document.createRange();
            finalRange.setStart(anchorNode, 0);
            finalRange.setEnd(anchorNode, 0);
            selection.removeAllRanges();
            selection.addRange(finalRange);
    
            setChipCounter((prev) => prev + 1);
            addChipData(chipData);
            updatePlainTextContent();
        }, [chipCounter, editorRef]);
    
        const handleNativeDragStart = useCallback((e: DragEvent) => {
            const chip = e.target as HTMLElement;
            setDraggedChip(chip);
            e.dataTransfer?.setData('text/plain', chip.textContent || '');
            chip.classList.add('opacity-50');
            e.stopPropagation();
        }, []);
    
        const handleNativeDragEnd = useCallback((e: DragEvent) => {
            const chip = e.target as HTMLElement;
            chip.classList.remove('opacity-50');
            setDraggedChip(null);
        }, []);
    
        const handleDragOver = useCallback(
            (e: React.DragEvent<HTMLElement>) => {
                if (!draggedChip || !editorRef.current) return;
                e.preventDefault();
    
                const range = getDropRange(e.clientX, e.clientY, editorRef.current);
    
                const oldIndicator = editorRef.current.querySelector('.drop-indicator');
                oldIndicator?.remove();
    
                if (range &amp;&amp; isValidDropTarget(range.commonAncestorContainer, editorRef.current)) {
                    const indicator = document.createElement('span');
                    indicator.className = 'drop-indicator inline-block w-0.5 h-4 bg-blue-500 mx-0.5';
                    range.insertNode(indicator);
                }
            },
            [draggedChip, editorRef]
        );
    
        const handleDrop = useCallback(
            (e: React.DragEvent<HTMLElement>) => {
                e.preventDefault();
                if (!draggedChip || !editorRef.current) return;
    
                const range = getDropRange(e.clientX, e.clientY, editorRef.current);
                if (!range || !isValidDropTarget(range.commonAncestorContainer, editorRef.current)) return;
    
                const indicator = editorRef.current.querySelector('.drop-indicator');
                indicator?.remove();
    
                const chipWrapper = draggedChip.parentNode as HTMLElement;
                range.insertNode(chipWrapper);
    
                const newRange = document.createRange();
                newRange.setStartAfter(chipWrapper);
                newRange.collapse(true);
    
                const selection = window.getSelection();
                selection?.removeAllRanges();
                selection?.addRange(newRange);
    
                normalizeContent();
                updatePlainTextContent();
            },
            [draggedChip, editorRef]
        );
    
        const convertSelectionToChip = useCallback(() => {
            const { text, range } = getSelectedText();
            const chipData = createNewChipData( {stringValue: text});
            const editor = editorRef.current;
    
            if (!editor) return;
    
            const chipWrapper = document.createElement('span');
            chipWrapper.className = 'chip-wrapper';
    
            const chip = createChipElement(chipData);
            chip.addEventListener('dragstart', handleNativeDragStart);
            chip.addEventListener('dragend', handleNativeDragEnd);
    
            const leadingSpace = document.createTextNode('\u00A0');
            const trailingSpace = document.createTextNode('\u00A0');
            const anchorNode = document.createTextNode('\u200B');
    
            chipWrapper.appendChild(chip);
    
            const insertionWrapper = document.createElement('span');
            insertionWrapper.appendChild(leadingSpace);
            insertionWrapper.appendChild(chipWrapper);
            insertionWrapper.appendChild(trailingSpace);
            insertionWrapper.appendChild(anchorNode);
    
            range.deleteContents();
            range.insertNode(insertionWrapper);
    
            // Move cursor after chip
            const finalRange = document.createRange();
            finalRange.setStart(anchorNode, 0);
            finalRange.setEnd(anchorNode, 0);
            const selection = window.getSelection();
            selection?.removeAllRanges();
            selection?.addRange(finalRange);
    
            setChipCounter((prev) => prev + 1);
            updatePlainTextContent();
            return true;
        }, [chipCounter, editorRef, handleNativeDragStart, handleNativeDragEnd]);
    
        const handleStyleChange = useCallback(
            (style: TextStyle) => {
                if (!editorRef.current) return;
                applyTextStyle(style);
                editorRef.current.focus();
                updatePlainTextContent();
            },
            [editorRef, updatePlainTextContent]
        );
    
        return {
            // State
            chipCounter,
            draggedChip,
            plainTextContent,
            chipData,
            colorAssignments,
    
            // Ref Manager methods
            insertChip,
            convertSelectionToChip,
            applyStyle: handleStyleChange,
            getText,
            normalize: normalizeContent,
            updateContent: updatePlainTextContent,
            focus,
    
            // Event handlers
            handleNativeDragStart,
            handleNativeDragEnd,
            handleDragOver,
            handleDrop,
            handleStyleChange,
            updatePlainTextContent,
            normalizeContent,
        };
    };
    &ZeroWidthSpace;&ZeroWidthSpace;"
                            data-broker-id="disconnected"
                            draggable="true"
                            >useState useCallback RefObject</span
                        ></span
                    ><span
                        contenteditable="false"
                        class="inline-flex items-center px-2 py-1 mx-1 rounded-md cursor-move bg-indigo-300 dark:bg-indigo-800 text-indigo-900 dark:text-indigo-100 hover:bg-indigo-400 dark:hover:bg-indigo-700 transition-colors duration-200"
                        data-chip="true"
                        data-chip-id="3085622b-d4f3-4abd-9653-987313f9ef20"
                        data-chip-label="New Chip 2"
                        data-chip-original-content=""
                        data-broker-id="disconnected"
                        draggable="true"
                        >New Chip 2</span
                    ></span
                >&nbsp;&ZeroWidthSpace;<span
                    >&nbsp;<span class="chip-wrapper"
                        ><span
                            contenteditable="false"
                            class="inline-flex items-center px-2 py-1 mx-1 rounded-md cursor-move bg-violet-300 dark:bg-violet-800 text-violet-900 dark:text-violet-100 hover:bg-violet-400 dark:hover:bg-violet-700 transition-colors duration-200"
                            data-chip="true"
                            data-chip-id="4cda5020-c2a7-4731-8a57-2b17d0986a44"
                            data-chip-label="New Chip 3"
                            data-chip-original-content=""
                            data-broker-id="disconnected"
                            draggable="true"
                            >New Chip 3</span
                        ></span
                    >&nbsp;&ZeroWidthSpace;<span
                        >&nbsp;<span class="chip-wrapper"
                            ><span
                                contenteditable="false"
                                class="inline-flex items-center px-2 py-1 mx-1 rounded-md cursor-move bg-fuchsia-300 dark:bg-fuchsia-800 text-fuchsia-900 dark:text-fuchsia-100 hover:bg-fuchsia-400 dark:hover:bg-fuchsia-700 transition-colors duration-200"
                                data-chip="true"
                                data-chip-id="782b0ea1-1e09-43b4-9aae-f046d64c56cc"
                                data-chip-label="New Chip 4"
                                data-chip-original-content=""
                                data-broker-id="disconnected"
                                draggable="true"
                                >New Chip 4</span
                            ></span
                        >&nbsp;&ZeroWidthSpace;<span
                            >&nbsp;<span class="chip-wrapper"
                                ><span
                                    contenteditable="false"
                                    class="inline-flex items-center px-2 py-1 mx-1 rounded-md cursor-move bg-rose-300 dark:bg-rose-800 text-rose-900 dark:text-rose-100 hover:bg-rose-400 dark:hover:bg-rose-700 transition-colors duration-200"
                                    data-chip="true"
                                    data-chip-id="49a145a5-ef2d-4037-af7a-05d8f9e34f4d"
                                    data-chip-label="New Chip 5"
                                    data-chip-original-content=""
                                    data-broker-id="disconnected"
                                    draggable="true"
                                    >New Chip 5</span
                                ></span
                            >&nbsp;&ZeroWidthSpace;<span
                                >&nbsp;<span class="chip-wrapper"
                                    ><span
                                        contenteditable="false"
                                        class="inline-flex items-center px-2 py-1 mx-1 rounded-md cursor-move bg-orange-300 dark:bg-orange-800 text-orange-900 dark:text-orange-100 hover:bg-orange-400 dark:hover:bg-orange-700 transition-colors duration-200"
                                        data-chip="true"
                                        data-chip-id="e9b747e2-82ab-404a-b61b-5bd922da4d5c"
                                        data-chip-label="New Chip 6"
                                        data-chip-original-content=""
                                        data-broker-id="disconnected"
                                        draggable="true"
                                        >New Chip 6</span
                                    ></span
                                >&nbsp;<span
                                    >&nbsp;
                                    <span class="chip-wrapper"
                                        ><span
                                            contenteditable="false"
                                            class="inline-flex items-center px-2 py-1 mx-1 rounded-md cursor-move bg-amber-300 dark:bg-amber-800 text-amber-900 dark:text-amber-100 hover:bg-amber-400 dark:hover:bg-amber-700 transition-colors duration-200"
                                            data-chip="true"
                                            data-chip-id="781d1437-503c-4dba-a6af-8aa36889a0bc"
                                            data-chip-label="New Chip 7"
                                            data-chip-original-content=""
                                            data-broker-id="disconnected"
                                            draggable="true"
                                            >New Chip 7</span
                                        > </span
                                    >&nbsp;<span
                                        >&nbsp;<span class="chip-wrapper"
                                            ><span
                                                contenteditable="false"
                                                class="inline-flex items-center px-2 py-1 mx-1 rounded-md cursor-move bg-emerald-300 dark:bg-emerald-800 text-emerald-900 dark:text-emerald-100 hover:bg-emerald-400 dark:hover:bg-emerald-700 transition-colors duration-200"
                                                data-chip="true"
                                                data-chip-id="401d918e-88e9-43d9-8956-a7fb40e8e236"
                                                data-chip-label="This is"
                                                data-chip-original-content="This is"
                                                data-broker-id="disconnected"
                                                draggable="true"
                                                >This is</span
                                            ></span
                                        >&nbsp;&ZeroWidthSpace;</span
                                    >
                                    <span
                                        >&nbsp;<span class="chip-wrapper"
                                            ><span
                                                contenteditable="false"
                                                class="inline-flex items-center px-2 py-1 mx-1 rounded-md cursor-move bg-purple-300 dark:bg-purple-800 text-purple-900 dark:text-purple-100 hover:bg-purple-400 dark:hover:bg-purple-700 transition-colors duration-200"
                                                data-chip="true"
                                                data-chip-id="0d41576b-fa73-4c6d-a08f-f4a84e6403a7"
                                                data-chip-label="my"
                                                data-chip-original-content="my"
                                                data-broker-id="disconnected"
                                                draggable="true"
                                                >my</span
                                            ></span
                                        >&nbsp;&ZeroWidthSpace;</span
                                    >text<span
                                        >&nbsp;<span class="chip-wrapper"
                                            ><span
                                                contenteditable="false"
                                                class="inline-flex items-center px-2 py-1 mx-1 rounded-md cursor-move bg-cyan-300 dark:bg-cyan-800 text-cyan-900 dark:text-cyan-100 hover:bg-cyan-400 dark:hover:bg-cyan-700 transition-colors duration-200"
                                                data-chip="true"
                                                data-chip-id="7ec746e2-93bd-44ee-8476-444fa98ce1d3"
                                                data-chip-label="New Chip 7"
                                                data-chip-original-content=""
                                                data-broker-id="disconnected"
                                                draggable="true"
                                                >New Chip 7</span
                                            ></span
                                        >&nbsp;<span
                                            >&nbsp;<span class="chip-wrapper"
                                                ><span
                                                    contenteditable="false"
                                                    class="inline-flex items-center px-2 py-1 mx-1 rounded-md cursor-move bg-sky-300 dark:bg-sky-800 text-sky-900 dark:text-sky-100 hover:bg-sky-400 dark:hover:bg-sky-700 transition-colors duration-200"
                                                    data-chip="true"
                                                    data-chip-id="f066a4d8-0dd6-44db-abad-511c9ffa3d01"
                                                    data-chip-label="New Chip 8"
                                                    data-chip-original-content=""
                                                    data-broker-id="disconnected"
                                                    draggable="true"
                                                    >New Chip 8</span
                                                ></span
                                            >&nbsp;&ZeroWidthSpace;</span
                                        >&ZeroWidthSpace;</span
                                    ></span
                                ></span
                            ></span
                        ></span
                    ></span
                ></span
            ></span
        ></span
    >
    <div>
        <span
            ><span
                ><span
                    ><span
                        ><span
                            ><span
                                ><span
                                    ><span><br /></span></span></span></span></span></span></span
        ></span>
    </div>
    <div>
        <span
            ><span
                ><span
                    ><span
                        ><span
                            ><span
                                ><span><span></span></span></span></span></span></span></span></span
        ><span>&nbsp;&nbsp;as</span>
    </div>
    <div>
        <span><br /></span>
    </div>
    <div>
        <span>&ZeroWidthSpace;</span>
        <div>
            <span
                ><span
                    ><span
                        ><span
                            ><span
                                ><span><span></span></span></span></span></span></span
            ></span>
        </div>
    </div>
</div>
