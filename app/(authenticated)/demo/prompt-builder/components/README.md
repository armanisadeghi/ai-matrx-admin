# Prompt Builder Architecture

This document explains the architecture and key concepts of the modular prompt builder system.

## Core Architecture

The prompt builder is a React-based system with the following key components:

1. **Context Provider** (`PromptBuilderContext.tsx`): Manages global state with React Context API
2. **Tab Components**: Each tab follows a two-component pattern:
   - Main wrapper component (e.g., `TaskTab.tsx`) that connects to the context
   - Inner content component that manages its specific form state
3. **Reusable Base Component** (`TabBase.tsx`): A shared component used by all tabs
4. **Constants** (`constants.tsx`): Defines all templates, tab structure, and metadata
5. **Main Builder** (`MainPromptBuilder.tsx`): Orchestrates everything and renders the UI

## Hardcoded Template System

The system uses a single hardcoded template string for flexibility and ease of editing:

1. **Master Template String**:
   - Located at the top of `PromptBuilderContext.tsx` as `PROMPT_TEMPLATE`
   - Contains placeholders in the format `<<TAB_N>><<T/AB_N>>` where N is the tab number
   - Can include fixed text before, after, or between placeholders
   - Simple to edit - just modify this string to change the structure

2. **Placeholder System**:
   - Each tab has a specific placeholder (e.g., `<<TAB_1>><<T/AB_1>>`)
   - The tab's content is stored in memory, not immediately substituted
   - Final substitution happens only when displaying the preview 

3. **Benefits**:
   - Easy to reorder tabs - just move placeholders around in the template
   - Simple to add fixed text between sections
   - Performance improvement - no constant regexp replacements
   - Clear control over the prompt structure

## Tab Content Management

The system now separates content storage from template manipulation:

1. **Content Storage**:
   - Each tab stores its content in the `tabContentMap` in Context
   - Content is updated via `updateTabContent(tabNumber, content)`

2. **Final Prompt Generation**:
   - Only happens when needed (viewing preview or explicitly requested)
   - Efficiently replaces all placeholders in a single operation
   - Removes disabled sections and empty placeholders

## Creating New Tabs

To add a new tab:

1. Create two new components:
   - Main tab component (e.g., `NewFeatureTab.tsx`)
   - Content component inside it that calls `updateTabContent()`
2. Add the tab to `constants.tsx`
3. Add the tab's placeholder to the `PROMPT_TEMPLATE` string

## Example Template

```
You are a friendly assistant.

<<TAB_1>><<T/AB_1>>

Some fixed text in the middle of the prompt.

<<TAB_2>><<T/AB_2>>
<<TAB_3>><<T/AB_3>>

Remember to be helpful!
```

This allows for precise control over prompt structure while keeping the system modular.

## Placeholder System

The placeholder system is what makes the builder modular and flexible:

1. **How It Works**:
   - Each tab has a placeholder in the format `<<TAB_N>><<T/AB_N>>` where N is the tab number
   - When a tab's content changes, it updates its content between these placeholders
   - The order of placeholders controls the structure of the final prompt
   - Empty placeholders are removed in the final output

2. **Initialization**:
   - On startup, `createTemplateWithPlaceholders()` creates a template with all placeholders
   - Each tab then updates its content within its placeholders

3. **Content Updates**:
   - When tab content changes, `TabBase` updates the global prompt using regex to replace its placeholder's content
   - The final prompt is generated by `generateFinalPrompt()` which cleans up empty placeholders

## Generic Tab Component

For simple tabs, you can use the `GenericTextareaTab` component which provides a basic textarea input with template processing.

## Preview Functionality

The `PreviewTab` shows both:
1. The final processed prompt (with placeholders removed)
2. The structural view showing where each tab's content fits within the template

## Type Definitions

Key TypeScript interfaces:

- `TabBaseProps`: Properties for the base tab component
- `ContentComponentProps`: Interface for content components that receive the `updateContent` function
- `PromptBuilderContextProps`: Type definition for the context API

## Example Flow

1. User enables a tab (e.g., "Tone & Style")
2. User selects options in the tab (e.g., "professional" tone with "balanced" detail)
3. The content component builds content text based on selections
4. Content is passed to `updateContent` function
5. `TabBase` updates the global prompt's placeholder for that tab
6. `PromptBuilderContext` processes the entire template to generate the final prompt
7. `PreviewTab` displays the resulting prompt

## Prompt Structure Control

The order of prompt sections is controlled by:
1. The order of tabs in `promptBuilderTabs` and `additionalTabs` arrays
2. The corresponding tab numbers
3. The original placement of placeholders in the template

This architecture makes it easy to add, reorder, or remove sections without breaking the system. 